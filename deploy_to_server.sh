#!/bin/bash

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–æ–≤–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üì± –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
pm2 stop ars-backend 2>/dev/null || echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ"

# 2. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é..."
cd /var/www
rm -rf ars_backend

# 3. –†–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∞—Ä—Ö–∏–≤
echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –±—ç–∫–µ–Ω–¥..."
tar -xzf ars_backend_new.tar.gz
mv ars_backend-* ars_backend 2>/dev/null || echo "–ü–∞–ø–∫–∞ —É–∂–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞"

# 4. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd ars_backend

# 5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üìö –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install --production

# 6. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
npm run build

# 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ dist —Å–æ–∑–¥–∞–ª—Å—è
if [ ! -d "dist" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ dist –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å!"
    exit 1
fi

# 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ public —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
if [ ! -f "public/index.html" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ public!"
    exit 1
fi

# 9. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
chown -R www-data:www-data /var/www/ars_backend
chmod -R 755 /var/www/ars_backend

# 10. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
pm2 start dist/main.js --name ars-backend
pm2 save

# 11. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å PM2
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 status

# 12. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx
echo "üåê –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Nginx..."
nginx -t && systemctl restart nginx

# 13. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Nginx
echo "üìä –°—Ç–∞—Ç—É—Å Nginx:"
systemctl status nginx --no-pager -l

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://turan-nedvijimost.kg/"
echo "üì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs ars-backend"
